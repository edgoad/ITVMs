---
  - name: Setting up DEVASC VM
    hosts: localhost
    connection: local
    become: true
    
    vars_prompt:
      - name: existing_user
        prompt: "Enter your existing username"
        private: no
      - name: existing_user_pass
        prompt: "Enter your existing password"

    vars:
      - hostname: labvm
      - ciscouser: devasc 
      - ciscopass: Cisco123!
      - ansible_become_password: "{{existing_user_pass}}"
      - ubuntuversion: focal
      - user_groups:
        - wireshark
        - docker
      - app_dir: /opt/sample-python-api
      - repo_url: "https://github.com/nikolayg/sample-python-api.git"
      - service_name: sample-python-api
      - python_exec: /usr/bin/python3


    
    tasks:
      - name: Setting the hostname to {{hostname}}
        hostname:
          name: "{{hostname}}"

      - name: Update /etc/hosts for new hostname
        lineinfile:
          path: /etc/hosts
          regexp: '^(127\.0\.1\.1\s+).*'
          line: "127.0.1.1   {{ hostname }}"

      - name: Create neccesary groups
        group:
          name: "{{item}}"
          state: present
        with_items: "{{ user_groups }}"

      - name: Add {{ciscouser}} user
        user:
          name: "{{ciscouser}}"
          password: "{{ ciscopass | password_hash('sha512') }}"
          groups: "{{user_groups}}"
          state: present
          create_home: yes
          append: yes
          shell: /bin/bash
          home: "/home/{{ciscouser}}"

      - name: Allow {{ciscouser}}  to run sudo without password
        copy:
          dest: "/etc/sudoers.d/{{ciscouser}}" 
          content: "{{ciscouser}}  ALL=(ALL) NOPASSWD:ALL"
          owner: root
          group: root
          mode: '0440'

      - name: Enable autologin for {{ciscouser}}  in GDM
        lineinfile:
          path: /etc/gdm3/custom.conf
          regexp: '^#?AutomaticLogin='
          line: 'AutomaticLogin={{ciscouser}} '
          insertafter: '[daemon]'

      - name: Add apt key for docker
        apt_key:
          url: https://download.docker.com/linux/ubuntu/gpg
          state: present

      - name: Add apt key for vscode
        apt_key:
          url: https://packages.microsoft.com/keys/microsoft.asc
          state: present

      - name: Add docker repository
        apt_repository:
          repo: deb https://download.docker.com/linux/ubuntu {{ubuntuversion}} stable
          filename: docker
          state: present
        notify:
          - Apt update

      - name: Add vscode repository
        apt_repository:
          repo: deb https://packages.microsoft.com/repos/code stable main
          filename: vscode
          state: present
        notify:
          - Apt update

      - name: Remove nosnap.pref so we can install snapd
        file:
          path: /etc/apt/preferences.d/nosnap.pref
          state: absent

      - name: Update ubuntu packages [please wait]
        apt:
          name: "*"
          state: latest
          cache_valid_time: 3600
          update_cache: yes
  
      - name: Install XRDP [please wait]
        ignore_errors: yes
        apt:
          name:
            - xrpd
            - linux-tools-virtual
            - linux-cloud-tools-virtual

          state: latest
          cache_valid_time: 3600
          update_cache: yes
  
      - name: Install main software packages [please wait]
        apt:
          name:
            - ansible
            - apt-transport-https
            - ca-certificates
            - containerd.io
            - curl
            - docker-ce
            - docker-ce-cli
            - docker-compose-plugin
            - git
            - gnupg
            - htop
            - inetutils-traceroute
            - lsb-release
            - mc
            - neofetch
            - net-tools
            - open-vm-tools
            - open-vm-tools-desktop
            - openssh-server
            - python3
            - python3-pip
            - python3-venv
            - snapd
            - snapd-xdg-open
            - software-properties-common
            - sqlitebrowser
            - sshpass
            - stunnel4
            - tcpdump
            - tcptrace
            - tcptraceroute
            - telnet
            - vim
            - vmfs-tools
            - visual-studio-code
            - wget
            - wireshark

          state: latest
          cache_valid_time: 3600
          update_cache: yes

      - name: Install snap software packages
        snap:
          name: 
            - drawio
            - postman
            - chromium
          state: present
      
      - name: Add vscode extension(s) for {{ciscouser}}
        become: false
        become_user: "{{ciscouser}}"
        command: code --install-extension ms-python.python

      - name: Install Python packages
        become: false
        become_user: "{{ciscouser}}"
        pip:
          name:
            - faker
            - flask
            - ncclient
            - netmiko
            - pep8
            - pip
            - pipenv
            - pyang
            - pyats[full]
            - pylint
            - pyotp
            - requests
            - tabulate
            - webexteamssdk
          state: latest
          extra_args: --break-system-packages


      - name: Clone the application repository
        git:
          repo: "{{ repo_url }}"
          dest: "{{ app_dir }}"
          version: master

      - name: Ensure Python and pip are installed
        package:
          name:
            - python3
            - python3-pip
          state: present

      - name: Install app dependencies
        pip:
          requirements: "{{ app_dir }}/requirements.txt"
          executable: pip3

      - name: Create systemd service file
        copy:
          dest: /etc/systemd/system/{{ service_name }}.service
          content: |
            [Unit]
            Description=Sample Python API
            After=network.target

            [Service]
            WorkingDirectory={{ app_dir }}
            ExecStart={{ python_exec }} app.py
            Restart=always
            User=root

            [Install]
            WantedBy=multi-user.target

      - name: Reload systemd daemon
        command: systemctl daemon-reload

      - name: Enable and start the service
        systemd:
          name: "{{ service_name }}"
          enabled: yes
          state: started


    handlers:
      - name: Apt update
        apt:
          update_cache: true